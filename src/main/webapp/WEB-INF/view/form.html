<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="initial-scale=1, user-scalable=0, minimal-ui">
    <title>年会签到表</title>
    <link rel="stylesheet" href="../view/css/style.css">
    <script type="text/javascript" src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
    <script src="http://apps.bdimg.com/libs/jquery/1.11.3/jquery.min.js"></script>

    <script>
        $(document).ready(function () {
            var weixinUrl = location.href.split('#')[0];
            //用户授权
            var authUrl = "http://zxc.tunnel.qydev.com/auth/url";
            $.ajax({
                url: authUrl, //这个地址是服务器配置JSSDK的地址
                data: {           // 这个地址是发生jssdk调用的url地址
                    // 用于服务器配置
                    url: weixinUrl,
                    state: ''
                }
            }).success(function (json) {
                console.log(JSON.stringify(json.data));
            });

            // 根据实际填写接口的配置地点
            // 这里的接口地址是基于node-weixin配置的。
            var weixinUrl = location.href.split('#')[0];
            var url = "http://zxc.tunnel.qydev.com/sign/url";
            // 当前的网页请求地址
            $.ajax({
                url: url, //这个地址是服务器配置JSSDK的地址
                data: {           // 这个地址是发生jssdk调用的url地址
                    // 用于服务器配置
                    url: weixinUrl
                }
            }).success(function (json) {       // 获得服务器返回的配置信息
                var data = json.data;
                var config = {};
                for (var k in json.data) {
                    config[k] = json.data[k];
                }
                config.debug = true;// 添加你需要的JSSDK的权限
                config.appId = config.appid;
                config.jsApiList = ['checkJsApi', 'getLocation', 'closeWindow'];
                config.timestamp = parseInt(config.timestamp);
                config.nonceStr = config.noncestr;
                config.signature = config.signature
                wx.config(config);

                wx.checkJsApi({
                    jsApiList: [
                        'getLocation'
                    ],
                    success: function (res) {
                        if (res.checkResult.getLocation == false) {
                            alert('你的微信版本太低，不支持微信JS接口，请升级到最新的微信版本！');
                            return;
                        }
                    }
                });
                //地理位置
                /*$('#getLocation').click(function () {
                 initWxConfig(window.location.href, '@Url.Action("GetWxConfig","Api")');//重新获取微信配置参数*/
                wx.getLocation({
                    type: 'wgs84',// 默认为wgs84的gps坐标，如果要返回直接给openLocation用的火星坐标，可传入'gcj02'
                    success: function (res) {
                        console.log(res, JSON.stringify((res)));
                        // alert(JSON.stringify(res));
                    },
                    cancel: function (res) {
                        alert('用户拒绝授权获取地理位置');
                    }
                });

                wx.ready(function () {
                    var getUserInfo = "http://zxc.tunnel.qydev.com/auth/user_info";
                    var weixin = location.href.split('=')[1];
                    var code = weixin.split('&')[0];
                    //获取用户信息
                    $.ajax({
                        url: getUserInfo, //这个地址是服务器配置JSSDK的地址
                        data: {           // 这个地址是发生jssdk调用的url地址
                            // 用于服务器配置
                            code: code,
                            lang: ''
                        }
                    }).success(function (json) {
                        var userInfo = json.data;
                        var openId = userInfo.openId;
                        console.log(userInfo, JSON.stringify(userInfo));

                        document.querySelector('#btnSign').onclick = function () {
                            var addUserUrl = "http://zxc.tunnel.qydev.com/user/save";
                            var signInfo = {
                                /* "userName": $("input[name='userName']").val(),
                                 "dept": $("select[name='dept']").val(),
                                 "phone": $("input[name='phone']").val(),*/
                                "headImgUrl": userInfo.headImgUrl,
                                "openId": openId
                            };
                            signInfo = JSON.stringify(signInfo);
                            console.log("info", signInfo);
                            $.ajax({
                                type: 'POST',
                                url: addUserUrl,
                                contentType: 'application/json',
                                data: signInfo
                            }).success(function (json) {
                                var msg = json.message;
                                if (msg == "成功") {
                                    window.location.href = "/view/success.html";
                                    wx.closeWindow();
                                }
                                console.log(JSON.stringify(json.message));
                            })
                        }
                    });
                });
                wx.error(function (res) {
                    //alert(res.errMsg);
                });
            });
        });
    </script>
    <style type="text/css">

    </style>
</head>
<body>
<div>
    <fieldset>
        <legend>图片</legend>
        <div class="form-row" style="width: 100px;height: 100px;float: left;clear: none">
            <img src="images/zysoft.jpg" style="width: 100px;height: 100px">
        </div>
        <div class="form-row" style="width: 200px;height: 100px;float: left;clear: none">
            <h2>年会签到表</h2>
            <span>感谢您参加智业年会，请登记您的签到信息。</span>
        </div>
    </fieldset>
</div>
<div>
    <fieldset>
        <legend>年会签到表</legend>
        <div class="form-row">
            <div class="field-label"><label for="userName">姓名</label>:</div>
            <div class="field-widget"><input name="userName" id="userName" class="required"></div>
        </div>
        <div class="form-row">
            <div class="field-label" style="width: 188px;"><label for="dept" style="width: 152px;">所属中心/分子公司</label>:
            </div>
            <div class="field-widget">
                <select id="field6" name="dept" class="validate-selection">
                    <option>--请选择--</option>
                    <option>区域产品中心</option>
                    <option>医院产品中心</option>
                    <option>智业互联</option>
                    <option>云顶伟业</option>
                    <option>福建区</option>
                </select>
            </div>
        </div>
        <div class="form-row">
            <div class="field-label"><label for="phone">电话</label>:</div>
            <div class="field-widget"><input name="phone" id="field7" class="required"></div>
        </div>
        <div class="form-row">
            <div class="field-label"><label></label></div>
            <div class="field-widget">
                <label class="field-label" style="width: 80px;" for="phone">是否点餐:</label>
                <input type="checkbox" name="isOrder" style="margin-top: 6px;">
            </div>
        </div>
        <div class="form-row">
            <input type="submit" class="submit" id="btnSign" value="签到"/>
        </div>
    </fieldset>
</div>
</body>
</html>